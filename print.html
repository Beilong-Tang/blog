<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Beilong Tang (DKU)</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="Demo site for mdBook Quickstart repo">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Welcome to my blog</a></li><li class="chapter-item expanded "><a href="paper/index.html"><strong aria-hidden="true">2.</strong> Paper</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="paper/masksr.html"><strong aria-hidden="true">2.1.</strong> MaskSR</a></li></ol></li><li class="chapter-item expanded "><a href="notes/notes.html"><strong aria-hidden="true">3.</strong> Notes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="notes/command.html"><strong aria-hidden="true">3.1.</strong> Linux Command</a></li><li class="chapter-item expanded "><a href="notes/rir.html"><strong aria-hidden="true">3.2.</strong> Noise RIR</a></li><li class="chapter-item expanded "><a href="notes/pytorch.html"><strong aria-hidden="true">3.3.</strong> Pytorch</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="notes/pytorch_index.html"><strong aria-hidden="true">3.3.1.</strong> Pytorch Index</a></li></ol></li><li class="chapter-item expanded "><a href="notes/load_kmeans.html"><strong aria-hidden="true">3.4.</strong> Load Kmeans</a></li><li class="chapter-item expanded "><a href="notes/slurm.html"><strong aria-hidden="true">3.5.</strong> Slurm</a></li></ol></li><li class="chapter-item expanded "><a href="diary.html"><strong aria-hidden="true">4.</strong> Diary</a></li><li class="chapter-item expanded "><a href="wavseflm.html"><strong aria-hidden="true">5.</strong> WavSEFLM</a></li><li class="chapter-item expanded "><a href="target/index.html"><strong aria-hidden="true">6.</strong> Target Speaker Seperation</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Beilong Tang (DKU)</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="welcome-to-my-blog"><a class="header" href="#welcome-to-my-blog">Welcome to my blog</a></h1>
<style>
        .container {
            display: flex;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
        }
        .container img {
            max-width: 200px;
            margin-right: 20px;
        }
        .container .text {
            flex: 1;
        }
    </style>
<div class="container">
        <img src="./assets/me.jpg" alt="OpenAI Logo">
        <div class="text">
            <p>This is Beilong Tang from Duke Kunshan University.
<p>This page currently serves as my note.</p>
</p>
        </div>
    </div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="paper"><a class="header" href="#paper">Paper</a></h1>
<ul>
<li><a href="paper/./masksr.html">MaskSR: Masked Language Model for Full-band Speech Restoration</a> (MaskSR)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="masksr"><a class="header" href="#masksr">MaskSR</a></h1>
<p>Publication Date: 4 June 2024, <a href="https://arxiv.org/abs/2406.02092"><em>link</em></a></p>
<h2 id="distorted-speech-encoder"><a class="header" href="#distorted-speech-encoder">Distorted Speech Encoder:</a></h2>
<p>using STFT with window_size:</p>
<pre><code class="language-python">import torch

audio = torch.randn(1, 3 * 44100) # 3 seconds with sample rate 44.1kHz

y = torch.stft(audio, 2048, 512, return_complex = True)

print(y.shape) # [F, T] 

w = torch.abs(y) # [F, T]

w = w.pow(0.3) # X_0.3 compressed power spectrogram with shape [F,T]

print(w.shape)

</code></pre>
<h2 id="cosine-scheduler"><a class="header" href="#cosine-scheduler">Cosine Scheduler</a></h2>
<p>During training, the masking ratio (from 0 to 1) will be applied to \( 9 \times T \) codebook by sampling \( r \sim \mathcal{U}(0, 1) \),</p>
<p>The cosine schedule function should be \( f(r) = cos(\frac{\pi}{2}r) \), this makes sure that \(f(0) = 1\) and \(f(1) = 0\).</p>
<p>The cross entropy loss is calculated on the masking position.</p>
<h2 id="classifier-free-guidance"><a class="header" href="#classifier-free-guidance">Classifier-free Guidance</a></h2>
<p>The Conditional logit \( l_g \) is used to measure \( P(x \mid c )\) where c is the prompt. In this case, c will be the speech encoder input.</p>
<p>The unconditional logit \(l_u\) is used to measure \( P(x \mid c )\) where the model predicts the output without any input.
During inference, we just replace the entire codebook with a embedding (null embedding) repeated \(T\) times, and predict the output and use that as the \(l_u\)
score. The logit score for inference is defined as \(l_g = (1 + w) l_c - w l_u\).</p>
<p>During training, for each epoch, we randomly select 10% of the training data to be replaced with the null embedding.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notes"><a class="header" href="#notes">Notes</a></h1>
<p>When reading audio, it is better to normalize it before doing other operations (to avoid nan problem).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-command"><a class="header" href="#linux-command">Linux Command</a></h1>
<blockquote>
<p>This page denotes the commonly used linux commands</p>
</blockquote>
<h2 id="unzip-a-file"><a class="header" href="#unzip-a-file">unzip a file</a></h2>
<pre><code class="language-shell">unzip example.zip -d /home/user/destination
</code></pre>
<h2 id="untar-targz"><a class="header" href="#untar-targz">untar .tar.gz</a></h2>
<pre><code class="language-shell">tar -xzvf filename.tar.gz -C /path/to/output/directory
</code></pre>
<h2 id="untar-tar"><a class="header" href="#untar-tar">untar .tar</a></h2>
<pre><code class="language-shell">mkdir output
tar -xvf x.tar -C output
</code></pre>
<h2 id="count-all-files-under-a-folder"><a class="header" href="#count-all-files-under-a-folder">Count all files under a folder</a></h2>
<pre><code class="language-shell">find . -type f | wc -l
</code></pre>
<h2 id="zip-a-file"><a class="header" href="#zip-a-file">zip a file</a></h2>
<pre><code class="language-shell"></code></pre>
<h2 id="tar-a-file"><a class="header" href="#tar-a-file">tar a file</a></h2>
<pre><code class="language-shell">tar -czvf archive_name.tar.gz /path/to/folder
</code></pre>
<h2 id="untar-extract-a-file"><a class="header" href="#untar-extract-a-file">Untar (extract) a file</a></h2>
<pre><code class="language-shell">tar -xzvf archive_name.tar.gz
</code></pre>
<h2 id="run-commands-in-multiple-lines"><a class="header" href="#run-commands-in-multiple-lines">Run commands in multiple lines</a></h2>
<p>Example:</p>
<pre><code class="language-shell">sbatch -J ${JOB_NAME} -p ${card} -e ${log_path}/${current_datetime}.err -o ${log_path}/${current_datetime}.out -N ${num_nodes} --cpus-per-task=${cpus_per_task} \
  --gres=dcu:${gpus_per_node} --ntasks-per-node=${ntasks_per_node} \
  --exclusive \
</code></pre>
<p>We can use <code>\</code> to seperate</p>
<p>wer   /public/home/qinxy/bltang/ml_framework_slurm/exp/dasb/target/wavlm_6_layer/output/wsj0_2mix/trans_output.txt</p>
<h2 id="restart-bluetooth"><a class="header" href="#restart-bluetooth">Restart bluetooth</a></h2>
<pre><code class="language-shell">sudo systemctl status bluetooth
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="noise-rir"><a class="header" href="#noise-rir">Noise RIR</a></h1>
<p>To create a audio with reverberation:</p>
<ul>
<li>get the RIR, resample it to the audio frame rate</li>
<li>convolve the audio with the rir</li>
</ul>
<p>Sample code:</p>
<pre><code class="language-python">import numpy as np 
import scipy.signal as s
import torchaudio
import torch
import torchaudio.transforms as T
def reverb_rir(frames,rir):
        """
        frames is the clean audio numpy with shape [1, T]
        rir is the rir numpy with shape [1, T']
        returns: reverberated audio with shape [T'] (numpy)
        """
        orig_frames_shape = frames.shape
        frames,filter = np.squeeze(frames),np.squeeze(rir)
        frames = s.convolve(frames,filter)
        actlev = np.max(np.abs(frames))
        if(actlev &gt; 0.99):
            frames = (frames / actlev) * 0.98
        frames = frames[:orig_frames_shape[1]]
        # print(frames.shape, orig_frames_shape)
        return frames

rir_impulse = "/home/bltang/work/data/impulse/datasets_fullband/impulse_responses/SLR26/simulated_rirs_48k/largeroom/Room002/Room002-00001.wav"
## 48khz

frame_path = "/home/bltang/work/voicefixer_main/test/clean/SSB00050001.wav"
## 44.1khz 
frame, frame_rate = torchaudio.load(frame_path)

rir, rir_rate = torchaudio.load(rir_impulse)

print(f"loaded audio frame: {frame.shape}, sample rate: {frame_rate}")
print(f"loaded rir: {rir.shape}, sample rate: {rir_rate}")

## downsample the rir to be 44.1khz
resampler = T.Resample(rir_rate, frame_rate, dtype=frame.dtype)
rir = resampler(rir)

frame = frame.numpy()
rir = rir.numpy()

## doing the convolution
output = reverb_rir(frame,rir)

output = torch.from_numpy(output).unsqueeze(0)
torchaudio.save("output.wav",output, frame_rate)
</code></pre>
<h2 id="perform-clipping"><a class="header" href="#perform-clipping">perform clipping:</a></h2>
<pre><code class="language-python">### perform clipping
clip_factor = 0.1
z = torch.clamp(output,min = output.min() * clip_factor, max = output.max() * clip_factor)
print(z.min())
torchaudio.save("clamp.wav",z, frame_rate)
</code></pre>
<audio controls autoplay muted>
  <source src="horse.ogg" type="audio/ogg">
  <source src="https://www.w3schools.com/html/horse.ogg" type="audio/mpeg">
Your browser does not support the audio element.
</audio><div style="break-before: page; page-break-before: always;"></div><h1 id="pytorch"><a class="header" href="#pytorch"># Pytorch</a></h1>
<p>This is the notes and tricks for pytorch.</p>
<h2 id="to"><a class="header" href="#to">to()</a></h2>
<p>When calling <code>to()</code> on tensors, it is not directly moving the original tensor to the specified device. Instead, it will move the copy of the tensor to the device and return the new tensor.</p>
<p>If you want the original tensor to be moved to the device, you should do</p>
<pre><code class="language-python">x = x.to(device)
</code></pre>
<p>However, if you want to move a model to a device, you can just do</p>
<pre><code class="language-python">model.to(device)
</code></pre>
<h2 id="ddp"><a class="header" href="#ddp">DDP</a></h2>
<p>For the gradients to correctly flow during training, we should only call the model's forward method instead of some other defined methods.</p>
<h2 id="torchcudaset_device"><a class="header" href="#torchcudaset_device">torch.cuda.set_device()</a></h2>
<p>When you're working with PyTorch and CUDA, setting the environment variable <code>CUDA_VISIBLE_DEVICES</code> will define which GPUs are available for PyTorch to use. However, it's important to note that this variable accepts a comma-separated list of device indices which PyTorch should remap to logically.</p>
<p>So if you have, for example, four GPUs in your system (indices 0, 1, 2, 3) and you set <code>CUDA_VISIBLE_DEVICES=2</code>, PyTorch will then only see one GPU, and it will be remapped to index 0 when accessed from PyTorch (not index 2).</p>
<p>Here's how you would set it and use <code>torch.cuda.set_device</code> in Python:</p>
<pre><code class="language-python">import os import torch  # Make only GPU with original index 2 available to PyTorch 
os.environ["CUDA_VISIBLE_DEVICES"] = "2"  # Since CUDA_VISIBLE_DEVICES is set to '2', PyTorch will see this as device '0' 
torch.cuda.set_device(0) ## Not 2
</code></pre>
<p>Remember, <code>torch.cuda.set_device</code> expects the logical device index, which means that, after setting <code>CUDA_VISIBLE_DEVICES</code>, the visible devices will start from zero regardless of their actual hardware indices.</p>
<p>So in your case, if setting <code>os.environ['CUDA_VISIBLE_DEVICES'] = '2'</code> and then calling <code>torch.cuda.set_device(2)</code> results in a device error, that's likely because you've changed what device "2" actually refers to. In reality, after setting <code>CUDA_VISIBLE_DEVICES</code>, the device you're trying to access is probably at index "0".</p>
<p>You should do the following:</p>
<pre><code class="language-python">
import os
import torch

os.environ['CUDA_VISIBLE_DEVICES'] = '2'  # Now there's only one GPU visible to the process.
torch.cuda.set_device(0)  # This refers to the single visible GPU, which is the original device 2.
</code></pre>
<p>Run these snippets before executing other PyTorch code that works with CUDA, as changing <code>CUDA_VISIBLE_DEVICES</code> after CUDA context has been initialized may not have an effect.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pytorch-index"><a class="header" href="#pytorch-index">Pytorch Index</a></h1>
<p>This post really helps:</p>
<p><a href="https://zhuanlan.zhihu.com/p/471313188">here</a></p>
<p>Let's assume we have tensor <code>A</code> of shape [B, H, C], the basic way to select the index of the batch is:</p>
<h2 id="atensor-tensor-"><a class="header" href="#atensor-tensor-">A[tensor, tensor, ...]</a></h2>
<p>This one will collect all the indexes across tensors at the same position, and use that as the index.</p>
<p>For example:</p>
<pre><code class="language-python">## creating A
t = torch.tensor([[1, 2], [3, 4]])
w = -t 
###
A = torch.cat((t.unsqueeze(0), w.unsqueeze(0))) # [2, 2, 2]
"""
A:
tensor([[[ 1,  2],
         [ 3,  4]],

        [[-1, -2],
         [-3, -4]]])
"""
batch = torch.LongTensor([[0,0],[1,1]]) # [2,2]
row = torch.LongTensor([[0,1],[1,1]])   # [2,2]
col = torch.LongTensor([[1,0],[1,0]])   # [2,2]
res = A[batch, row, col]
"""
tensor([[ 2,  3],
        [-4, -3]])
"""
</code></pre>
<p>In the above code, the index is <code>(0,0,1) (0,1,0) (1,1,1) (1 1 0)</code></p>
<p>The result is <code>[[A[0,0,1],A[0,1,0]],[A[1,1,1],A[1,1,0]]]</code></p>
<h2 id="atensor"><a class="header" href="#atensor">A[tensor]</a></h2>
<p>Assume we only have one tensor as indexing tensor.</p>
<p>As the example above, we only use the <code>batch</code> tensor to index <code>A</code>, therefore
we will have a result tensor of shape <code>2,2,2,2</code></p>
<pre><code class="language-python">A[batch]
"""
torch.Size([2, 2, 2, 2])
"""
</code></pre>
<p>The principle is simple. For each element in the index, we take the corresponding element in A.</p>
<p>Therefore, the result will be <code>[[A[0],A[0]], [A[1],A[1]]]</code>.
Each element in A has shape <code>[2,2]</code>, so the result will be of shape <code>[2,2,2,2]</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="load-kmeans"><a class="header" href="#load-kmeans">Load Kmeans</a></h1>
<pre><code class="language-python">import os 
import sys 
import pickle
import joblib
import torch
from sklearn.cluster import MiniBatchKMeans
sys.path.append("../") 
from models.modules.kmeans import KMeansQuantizer as Kmeans
</code></pre>
<pre><code class="language-python">### load kmeans model
kmeans_ckpt = "/home/bltang/work/test/kmeans_4096_batch_size_16.pkl"
def load_dict(file_path):
    with open(file_path, "rb") as file:
        return pickle.load(file)
res = load_dict(kmeans_ckpt)
</code></pre>
<pre><code>/home/bltang/.local/lib/python3.8/site-packages/sklearn/base.py:348: InconsistentVersionWarning: Trying to unpickle estimator MiniBatchKMeans from version 1.5.1 when using version 1.3.2. This might lead to breaking code or invalid results. Use at your own risk. For more info please refer to:
https://scikit-learn.org/stable/model_persistence.html#security-maintainability-limitations
  warnings.warn(
</code></pre>
<pre><code class="language-python">for key in res:
    print(key)
</code></pre>
<pre><code>resume
step
feature_list
kmeans
</code></pre>
<pre><code class="language-python">kmeans_model:MiniBatchKMeans = res["kmeans"]
joblib.dump(kmeans_model, "/home/bltang/work/wavlm_kmeans_backend/ckpt/kmeans_gigaspeech_4096.pt")
</code></pre>
<pre><code>['/home/bltang/work/wavlm_kmeans_backend/ckpt/kmeans_gigaspeech_4096.pt']
</code></pre>
<pre><code class="language-python">kmeans_pytorch = Kmeans("/home/bltang/work/wavlm_kmeans_backend/ckpt/kmeans_gigaspeech_4096.pt")
</code></pre>
<h2 id="test"><a class="header" href="#test">Test</a></h2>
<pre><code class="language-python">x = torch.randint(0,4096, (2, 30)).long()
print(x)
kmeans_pytorch.emb(x)
</code></pre>
<pre><code>tensor([[1418, 1143,  728, 3682, 2837,  299, 2354, 1865,  156,  830,  409,  892,
         3274, 3682,  872,  510, 3785, 3780, 3297, 1187, 1234, 2075,  616, 2053,
         1168,  635,  320, 1091,  738, 2829],
        [ 158,  830, 4059, 3800, 1810, 2425, 3992, 1535, 3935, 1102,  297, 1540,
         2149, 2414, 1222, 3968, 3072, 3858, 1115,  701, 2100, 2951, 1291, 3721,
         1296, 2966,  960, 2327, 2188, 1239]])





tensor([[[ 3.4845,  0.5973, -0.2941,  ...,  1.8850, -3.3292, -3.1918],
         [-0.9843, -1.8948,  0.1781,  ...,  1.0470, -2.2949, -3.0003],
         [-2.4003, -0.3012,  2.5385,  ...,  0.2260, -0.4540, -0.7819],
         ...,
         [ 1.5334, -1.6515,  0.1410,  ...,  0.8672, -1.2393, -0.5327],
         [ 1.1343, -0.0071,  0.2196,  ...,  1.9066, -3.0079, -2.2519],
         [-0.8302,  0.0227,  2.9222,  ..., -0.1998,  0.5812, -1.3175]],

        [[ 0.5794,  0.3916,  3.1679,  ..., -0.7281, -0.7220, -0.4178],
         [-0.6731, -1.0334,  2.3820,  ...,  2.1921, -1.0713, -0.1829],
         [-1.8742, -3.6283, -0.3614,  ...,  1.6077, -1.6078, -2.0266],
         ...,
         [-0.5319, -0.7900,  2.3659,  ..., -1.6811, -1.6981, -2.6017],
         [ 3.1977, -3.8897,  0.7760,  ..., -1.5524,  2.8854, -2.0698],
         [ 0.0547, -0.4102,  2.9803,  ...,  0.2289, -0.3999, -1.0432]]])
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="slurm"><a class="header" href="#slurm">Slurm</a></h1>
<p>To run single task using 4 gpus:</p>
<pre><code class="language-shell">#!/bin/bash
#SBATCH -J train_test
#SBATCH -n 32
#SBATCH -N 1
#SBATCH --gres=dcu:4
#SBATCH -p kshdnormal02
python ... # The command to run
</code></pre>
<p>Note that no <code>srun</code> before the command</p>
<p>To run 8 tasks on a single node, you can run</p>
<pre><code class="language-shell">#!/bin/bash
#SBATCH -J train_test
#SBATCH --ntasks-per-node=8
#SBATCH -N 1
#SBATCH --cpus-per-task=2
#SBATCH --gres=dcu:4
#SBATCH -p kshdnormal
srun python test.py
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="diary"><a class="header" href="#diary">Diary</a></h1>
<h2 id="2024-june-6"><a class="header" href="#2024-june-6">2024 June 6</a></h2>
<div style="break-before: page; page-break-before: always;"></div><style>
        .audio-container {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Space between the rows */
        }
        .audio-row {
            display: flex;
            gap: 10px; /* Space between the audio elements in a row */
        }
        .audio-item {
            flex: 1; /* Make each audio item take up an equal amount of space */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .audio-item audio {
            width: 100%; /* Make audio elements take the full width of their container */
        }
    </style>
<h1 id="wavseflm"><a class="header" href="#wavseflm">WavSEFLM</a></h1>
<p>Using WavLM and SEF Network and Lanaguage Model for target Speaker Separation</p>
<p>Full audio goes to <a href="https://github.com/Beilong-Tang/blog/tree/main/src/audio/wavseflm">here</a>.</p>
<p>The highest similarity audio is 4, 16, 19.</p>
<p>The encoder decoder loses the information of a male voice: 21, 22, 23 (Must train kmeans and vocoder).</p>
<p>Not clear audio: 6, 17, 21.</p>
<p>The reat audios suffer from tone loss.</p>
<p>demo:</p>
<div class="audio-container" id="audioContainer">
        <!-- Rows will be dynamically added here -->
    </div>
<script>
        // Number of rows to create
        const numRows = 23;
        const audiosPerRow = 5;

        // Get the container element
        const container = document.getElementById('audioContainer');
        const name = ["mix", "clean", "output_", "output_mse", "regi"]

        // Loop to create rows
        for (let i = 0; i <= numRows; i++) {
            // Create a new div for each row
            const row = document.createElement('div');
            row.className = 'audio-row';

            // Loop to create audio elements within the row
            for (let j = 0; j < audiosPerRow; j++) {
                const audioIndex = i * audiosPerRow + j + 1;

                // Create a container for each audio and its caption
                const audioItem = document.createElement('div');
                audioItem.className = 'audio-item';

                // Create the audio element
                const audio = document.createElement('audio');
                audio.controls = true;
                const source = document.createElement('source');
                source.src = `./audio/wavseflm/${i}_${name[j]}.wav`; // Dynamic source based on the index
                source.type = 'audio/mpeg';
                audio.appendChild(source);

                // Create the caption
                const caption = document.createElement('p');
                caption.textContent = `${name[j]}_${i}.wav`;

                // Append the audio and caption to the audio item container
                audioItem.appendChild(audio);
                audioItem.appendChild(caption);

                // Append the audio item to the row
                row.appendChild(audioItem);
            }

            // Append the row to the container
            container.appendChild(row);
        }
    </script>
<!-- <script>
        // Number of rows to create
        const numRows = 20;

        // Get the container element
        const container = document.getElementById('audioContainer');

        // Loop to create rows
        for (let i = 1; i <= numRows; i++) {
            const row_ = document.creatElement('div')
            row_.className = "audio-container"
            for (let j = 0; j< 4; j++){
            // Create a new div for each row
            const row = document.createElement('div');
            row.className = 'audio-item';

            // Create the audio element
            const audio = document.createElement('audio');
            audio.controls = true;
            const source = document.createElement('source');
            source.src = `audio${i}.mp3`; // Dynamic source based on the index
            source.type = 'audio/mpeg';
            audio.appendChild(source);

            // Create the caption
            const caption = document.createElement('p');
            caption.textContent = `Caption for Audio ${i}`;

            // Append the audio and caption to the row
            row.appendChild(audio);
            row.appendChild(caption);

            // Append the row to the container
            row_.appendChild(row)
            
            }
            container.appendChild(row_);
        }
    </script> --><div style="break-before: page; page-break-before: always;"></div><h1 id="target-speaker-seperation"><a class="header" href="#target-speaker-seperation">Target Speaker Seperation</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
